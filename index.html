<!doctype html>

<html>
  <head>
<meta name = "viewport" content = "initial-scale = 1.0">
<style>
  * {
    font-family: Courier;
    margin: 0; paddig: 0;
  }
  .cursor {
    background-color: lightblue;
  }

</style>
<script src="underscore-min.js"></script>
<script src="zepto.min.js"></script>
</head>
<body style="height:1200px;">
  <canvas id="c"></canvas>
</body>
<script id="s">//stuff
  setTimeout(function () { window.scrollTo(0, 1) }, 100)

  var screen_width = 320
  var screen_height = screen.height

  var mode = "scroll"
  var line  = []
  var lines = [line]
  var y_cursor = 0
  var x_cursor = 0
  var x_offset = 0
  var y_offset = 0
  var viewport_width = 320
  var x_viewport = 16

  var viewport_height = 360

  var y_viewport = 10
  var chr_width = (viewport_width / x_viewport)
  var chr_height = (viewport_height / y_viewport)

  var font_size = 35

  var c = $("#c")
  var canvas_width = screen_width
  var canvas_height = screen_height
  c.css({
    width: canvas_width + "px",
    height: canvas_height + "px" ,
    position: "absolute",
    left: 0,
    "top": 0
  })
  c.attr("width", canvas_width * 2)
  c.attr("height", canvas_height * 2)
  var ctx = c[0].getContext("2d")
  ctx.scale(2,2)

  var tick = function () {
     
  }

  webkitRequestAnimationFrame(tick)


  var clear_viewport = function () {
    ctx.clearRect(0,0, viewport_width, viewport_height)
  }

  var render = function () {
    render_raw(move_factor(x_offset), move_factor(y_offset))   
    // # todo maybe cache the result of the move_factor call
  }

  var draw_cursor = function (x_offset, y_offset) {
    var x = (x_offset + chr_width * x_cursor)
    var y = (y_offset + chr_height * y_cursor)
    ctx.save()
    ctx.fillStyle = "rgba(0,0,255, 0.5)"
    ctx.fillRect(x,y, chr_width, chr_height)
    ctx.restore()
  }

  var draw_text = function (x_offset, y_offset) {
  
  }

  var render_raw = function (x_offset, y_offset) {
    // todo: can optimize this to know when it should change
    clear_viewport()

    ctx.save()
    ctx.fillStyle = "rgba(255, 255, 0, 0.1)"
    ctx.fillRect(0,0,screen_width, screen_height)
    ctx.restore()

    draw_cursor(x_offset, y_offset)
    draw_text(x_offset, y_offset)
    var c_line
    //for (var y = y_offset; y < y_offset + y_viewport; y++) {
    //  c_line = lines[y];
    //  if (!c_line) continue;
    //  for (var x = x_offset; x < x_offset + x_viewport; x++) {
    //    var c_chr = c_line[x];
    //    var cell = cells[x_viewport * (y - y_offset) + (x - x_offset)]
    //    cell.text(c_chr)
    //  }
    //}
  }

  var text_to_lines = function (text) {
    var lines = text.split("\n");
    for (var i = 0; i < lines.length; i++) {
      var line = lines[i];
      lines[i] = line.split("");
    }
    return lines
  }

  var log_index = 0
  var l = function(m){
    log_index += 1
    document.title = 
      log_index + " " + m
  }

  var touch = {}
     
  //https://github.com/drewlesueur/mobile/blob/server/public/index.js
  var move_factor = function (z) {
    return -1 * parseInt(z / 10) 
  }
  
  var mouse = "up"
  auto_mouseup = false
  setTimeout(function () {
    var auto_mouseup = true
  }, 1000)


  var mousedown = function (e) {
    console.log("mousedown")
    touchstart({ preventDefault: function () {}, touches: [{pageX: e.pageX, pageY: e.pageY}]})
    mouse = "down"
  }

  var mousemove = function (e) {
    if (mouse == "up") return
    touchmove({ preventDefault: function () {}, touches: [{pageX: e.pageX, pageY: e.pageY}]})

    if (auto_mouseup) {
      auto_mouseup = false
      mouseup()
    }
  }

  var mouseup = function () {
    mouse = "up"
    console.log("mouseup")
    touchend()
  }

  var touchstart = function (e) {
    e.preventDefault()
    touch.y1 = e.touches[0].pageY
    touch.x1 = e.touches[0].pageX
    touch.y2 = touch.y1
    touch.x2 = touch.x1
    touch.pageX = e.touches[0].pageX
    touch.pageY = e.touches[0].pageY
    touch.start = Date.now()
  }

  var touchmove = function  (e) {
    touch.y2 = e.touches[0].pageY
    touch.x2 = e.touches[0].pageX
    if (mode == "scroll") {
      var temp_x_offset = (x_offset + touch.x2 - touch.x1)
      var temp_y_offset = (y_offset + touch.y2 - touch.y1)
      console.log(temp_x_offset, temp_y_offset)
      render_raw(temp_x_offset, temp_y_offset)   
    } else if (mode == "letters") {
      var tmp_letter = get_letter(e.touches[0].pageX, e.touches[0].pageY); 
      if (tmp_letter == "backspace") {
        lines[y_cursor].splice(x_cursor - 1,1)
        x_cursor -= 1
      } else {
        lines[y_cursor].splice(x_cursor, temping_a_letter, tmp_letter)
        temping_a_letter = 1
      }
      render()   

    }

    e.preventDefault()
  }

  var input_letter = function (quadrant_path) {
    var path = quadrant_path.join("")
    notes.text(path) 
    letter = letter_map[path]
    if (!letter) return;
    if (letter == "backspace") {
      lines[y_cursor].splice(x_cursor - 1,1)
      x_cursor -= 1
    } else {
      lines[y_cursor].splice(x_cursor, 0, letter)
      x_cursor += 1
    }
    render()   
  }
  var touchend = function (e) {
    if (mode == "scroll") {
      x_offset = (x_offset + touch.x2 - touch.x1)
      y_offset = (y_offset + touch.y2 - touch.y1)
      if (touch.y2 == touch.y1 && touch.x2 == touch.x1) {
        y_cursor = move_factor(y_offset) + parseInt(touch.pageY / chr_height)
        x_cursor = move_factor(x_offset) + parseInt(touch.pageX / chr_width)
        
       if (y_cursor >= lines.length) {
         y_cursor = lines.length - 1
       }

       if (x_cursor > lines[y_cursor].length) {
         x_cursor = lines[y_cursor].length
       }
       render()   
      }
    } else if (mode == "letters") {
       
      if (touch.y2 == touch.y1 && touch.x2 == touch.x1) {
      } else {
        x_cursor += 1
        render()   
      }
    }
  } 

  $(document).ready(function () {
    if (screen.width > 320) {
      $(document.body).bind("mousedown", mousedown)
      $(document.body).bind("mousemove", mousemove)
      $(document.body).bind("mouseup", mouseup)
    
    } else {
      $(document.body).bind("touchstart", touchstart)
      $(document.body).bind("touchmove", touchmove)
      $(document.body).bind("touchend", touchend)
    
    }
  })



  var code = "hi"
  lines = text_to_lines(code)
  render()
</script>
</html>

