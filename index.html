<!doctype html>

<html>
  <head>
<meta name = "viewport" content = "initial-scale = 1.0">
<style>
  * {
    font-family: Courier;
    margin: 0; paddig: 0;
  }
  .cursor {
    background-color: lightblue;
  }
</style>
<script src="underscore-min.js"></script>
<script src="zepto.min.js"></script>
</head>
<body style="height:1200px;">
  <div id="w">
  </div>
  <div id="k">
    <br />
    <div id="notes"></div>
  </div>
</body>
<script id="s">//stuff
  setTimeout(function () { window.scrollTo(0, 1) }, 100)

  var mode = "scroll"
  var line  = []
  var lines = [line]
  var y_index = 0
  var x_index = 0
  var x_offset = 0
  var y_offset = 0
  var screen_width = 320
  var x_viewport = 16

  var screen_height = 360
  var y_viewport = 10
  var chr_width = (screen_width / x_viewport)
  var chr_height = (screen_height / y_viewport)

  font_size = 35
  w = $("#w")
  w.css({"width": screen_width + "px", "height": screen_height + "px"})
  notes = $("#notes")
  var cells = []
  var setup_screen = function () {
    cells = []
    for (var y = 0; y < y_viewport; y++) {
      for (var x = 0; x < x_viewport; x++) {
        var chr = $("<div>");
        chr.css({
          "left": x*chr_width,
          "top": y*chr_height,
          "position": "absolute",
          "width":  chr_width + "px",
          "height":  chr_height + "px",
          "font-size":  font_size + "px",
          "text-align": "center"
        })
        chr.attr("id", "c" + x + "_" + y)
        cells.push(chr)
        chr.text("a")
        w.append(chr)
      } 
    }
  }

  var clear = function () {
    $(".cursor").removeClass("cursor") //is this slow?
    for (var y = 0; y < y_viewport; y++) {
      for (var x = 0; x < x_viewport; x++) {
        var cell = cells[x_viewport * y + x]
        cell.text("")
      }
    }
  }

  var render = function (x_offset, y_offset) {
    notes.text(x_offset + " " + y_offset)
    clear()
    $("#c" + (-x_offset + x_index) + "_" + (-y_offset + y_index)).addClass("cursor");
    var c_line
    for (var y = y_offset; y < y_offset + y_viewport; y++) {
      c_line = lines[y];
      if (!c_line) continue;
      for (var x = x_offset; x < x_offset + x_viewport; x++) {
        var c_chr = c_line[x];
        var cell = cells[x_viewport * (y - y_offset) + (x - x_offset)]
        cell.text(c_chr)
      }
    }
  }

  var text_to_lines = function (text) {
    var lines = text.split("\n");
    for (var i = 0; i < lines.length; i++) {
      var line = lines[i];
      lines[i] = line.split("");
    }
    return lines
  }
  setup_screen();
  var log_index = 0
  var l = function(m){
    log_index += 1
    document.title = 
      log_index + " " + m
  }

  var touch = {}
  var touchstart = function (e) {
    e.preventDefault()
    if (mode == "scroll") {
      touch.y1 = e.touches[0].pageY
      touch.x1 = e.touches[0].pageX
    }
  }
     
  //https://github.com/drewlesueur/mobile/blob/server/public/index.js

  var move_factor = function (z) {
    return -1 * parseInt(z / 10) 
  }
  
  var last_quadrant = null;

  var quadrant_map = {
    lefttop: "a",
    leftmiddle: "c",
    leftbotton: "e",
    righttop: "b",
    rightmiddle: "d",
    rightbottom: "f",
  }

  var get_quadrant = function (x, y) {
    // ab
    // cd
    // ef
    var x_full = screen.width
    var x_one_half = x_full / 2

    var y_full = screen.height
    var y_one_third = screen.height / 3
    var y_two_thirds = y_one_third * 2
    var x_place, y_place;

    if (x < x_one_half)  x_place = "left";
    else x_place = "right";

    if (y < y_one_third)  y_place = "top";
    else if (y < y_two_thirds)  y_place = "middle";
    else y_place = "bottom";
    return quadrant_map[x_place + y_place]
  }

  var quadtrant_path = []
  var touchmove = function  (e) {
    if (mode == "scroll") {
      touch.y2 = e.touches[0].pageY
      touch.x2 = e.touches[0].pageX
      var temp_x_offset = (x_offset + touch.x2 - touch.x1)
      var temp_y_offset = (y_offset + touch.y2 - touch.y1)
      render(move_factor(temp_x_offset), move_factor(temp_y_offset))   
    } else if (mode == "letters") {
      var quadrant = get_quadrant(e.touches[0].pageX, e.touches[0].pageY); 
      if (quadrant != last_quadrant) {
        quadrant_path.push(quadrant) 
      }

      last_quadrant = quadrant;
    }

    e.preventDefault()
  }

  var input_letter = function (quadrant_path) {
  
  }

  var touchend = function (e) {
    if (mode == "scroll") {
      x_offset = (x_offset + touch.x2 - touch.x1)
      y_offset = (y_offset + touch.y2 - touch.y1)
      if (touch.y2 == touch.y1 && touch.x2 == touch.x1) {
        mode = "letters"
        y_index = e.touches[0].pageY / chr_height
        x_index = e.touches[0].pageX / chr_width
        render()
      }
    } else if (mode == "letters") {
      if (touch.y2 == touch.y1 && touch.x2 == touch.x1) {
        mode = "scroll"
      } else {
        input_letter(quadrant_path) 
     }
    }
  } 

  $(document).ready(function () {
    w.bind("touchstart", touchstart)
    w.bind("touchmove", touchmove)
    w.bind("touchend", touchend)
  })



  var code = $("#s").html()
  //var code = "yo world\ntesting some code\nshould be able to scroll"; 
  lines = text_to_lines(code)
  render(1, 0)
</script>
</html>

